version: 2.1
defaults: &defaults
  docker:
    - image: node:lts-slim

jobs:
  mac:
    macos:
      xcode: 12.5.1 # indicate your selected version of Xcode
    steps: # a series of commands to run
      - checkout  # pull down code from your version control system.
      - run: brew install nodejs
      - run: yarn install || sleep 1 && yarn install || sleep 2 && yarn install || sleep 2 && yarn install || sleep 2 && yarn install || sleep 2 && yarn install
      - run: yarn run build
      - run: yarn run build:apm
      - run: PLAYWRIGHT_JUNIT_OUTPUT_NAME=/tmp/report.xml npx playwright test --reporter=junit,list
      - store_test_results:
          path: /tmp/report.xml
      - store_artifacts:
          path: /tmp/report.xml
      - store_artifacts:
          path: ./tests/videos

  linux:
    <<: *defaults
    steps:
      - checkout
      - run: apt-get update
      - run: export DEBIAN_FRONTEND="noninteractive"
      - run: apt-get install -y
                  build-essential
                  git
                  libsecret-1-dev
                  fakeroot
                  libx11-dev
                  libxkbfile-dev
                  libgdk-pixbuf2.0-dev
                  libgtk-3-dev
                  libxss-dev
                  libasound2-dev
                  libnss3
                  xvfb
      - run: yarn install || sleep 1 && yarn install || sleep 2 && yarn install || sleep 2 && yarn install || sleep 2 && yarn install || sleep 2 && yarn install
      - run: yarn run build
      - run: yarn run build:apm
      - run: Xvfb :99 & DISPLAY=:99 PLAYWRIGHT_JUNIT_OUTPUT_NAME=/tmp/report.xml npx playwright test --reporter=junit,list
      - store_test_results:
          path: /tmp/report.xml
      - store_artifacts:
          path: /tmp/report.xml
      - store_artifacts:
          path: ./tests/videos
      - run: 'yarn dist --linux'
      - store_artifacts:
          path: dist/?tom*


workflows:
  version: 2
  default-workflow:
    jobs:
      - linux
      - mac
